import { useEffect, useRef, useState, useContext } from 'react'
import SpeechRecognition, { useSpeechRecognition } from 'react-speech-recognition'
import NotesContext from '../../context/NotesContext'
import { LocalizationContext } from '../../context/LocalizationContext'
import strings from '../../utils/localization'
import BackButton from './BackButton'
import styles from './CreateNote.module.scss'

function CreateNote() {
    const { onSave, onOpenSave, onOpenAddPassword, password, setPassword, isPasswordActive, isSaveActive, savedLang } = useContext(NotesContext)
    const { language } = useContext(LocalizationContext)

    const [title, setTitle] = useState('')
    const [text, setText] = useState('')

    // очищаем пароль, если заметка не сохранена
    useEffect(() => {
        return () => setPassword('')
    }, [setPassword])

    // сохранение заметки
    async function saveNote() {
        if (!text.trim()) return
    
        const note = ({
            title: title.trim(),
            content: text,
            createdAt: Date.now(),
            updatedAt: Date.now(),
        })

        const id = await onSave(note)

        const finalTitle = title.trim() || `${strings.note} №${id}`
    
        onOpenSave(finalTitle)
        stopRecognition()
    }

    function addPasswordNote() {
        if (!text.trim()) return

        onOpenAddPassword()
        stopRecognition()
    }

    // ручной ввод
    function handleInput(e) {
        setText(e.currentTarget.innerHTML)
    }

    // голосовой ввод
    const [prev, setPrev] = useState('')
    const editorRef = useRef(null)
    const { transcript, listening, resetTranscript } = useSpeechRecognition()

    useEffect(() => {
        if (!listening) {
            setPrev('')
            return
        }
    
        if (transcript.length <= prev.length) return
    
        const newPart = transcript.slice(prev.length)
        setPrev(transcript)
    
        if (editorRef.current) {
            // вставляем в конец текущего контента
            editorRef.current.innerHTML += newPart
            setText(editorRef.current.innerHTML)
            
            // скроллим вниз
            editorRef.current.scrollTop = editorRef.current.scrollHeight
        }
    }, [transcript, listening, prev])

    function startRecognition() {
        resetTranscript()
        setPrev('')
        SpeechRecognition.startListening({
            continuous: true,
            language: savedLang === 'ru' ? 'ru-RU' : 'en-US',
        })
    }
    
    function stopRecognition() {
        SpeechRecognition.stopListening()
        setPrev('')

        if (editorRef.current) {
            let html = editorRef.current.innerHTML

            if (html && !html.endsWith(' ') && !html.endsWith('<br>')) {
                html += ' '
                editorRef.current.innerHTML = html
            }
    
            setText(html)
        }
    }

    return (
        <div className={styles.create} data-lang={language}>
            <div className={styles.createButtons}>
                <div className={styles.createButtonsItems}>
                    <BackButton />
                </div>
                <div className={styles.createButtonsItems}>
                <p>{strings.createMicrophone}: <span>{listening ? `${strings.createOn}` : `${strings.createOff}`}</span></p>

                    {!listening && <button onClick={startRecognition}>
                        <svg width="17" height="20" viewBox="0 0 17 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M5.22668 0.0292606C4.63709 0.125435 3.9806 0.531038 3.60844 1.02027C3.3032 1.42587 3.14848 1.81893 3.06903 2.39179L3.04395 2.59251L4.35275 2.60087L5.66573 2.61341L5.67828 2.87685C5.70336 3.36608 5.49011 3.84277 5.1305 4.10202C4.84616 4.30691 4.62872 4.34873 3.79661 4.34873H3.05231V4.99685V5.64498H4.37365H5.69918L5.67828 6.02132C5.64064 6.64436 5.39812 7.03741 4.89216 7.2883C4.72072 7.37193 4.63291 7.3803 3.88024 7.39284L3.05231 7.40957V8.05351V8.69746H4.37365H5.69918L5.67828 9.06961C5.64064 9.69265 5.42321 10.0606 4.94234 10.2948L4.66636 10.4328L3.85933 10.4453L3.05231 10.462L3.06067 11.3234L3.07322 12.189L5.17232 12.2015L7.27142 12.2099L7.76483 11.7165C8.26661 11.2105 8.70148 10.8886 9.2618 10.6042L9.5545 10.4579L8.91056 10.4537H8.26661L8.28752 10.0773C8.32515 9.45431 8.56768 9.06125 9.07363 8.81454C9.24507 8.73091 9.33707 8.71837 10.0897 8.70582L10.9135 8.6891V8.04515V7.4012H9.59214H8.26661L8.28752 7.02487C8.30842 6.71126 8.33351 6.59836 8.44223 6.37674C8.59276 6.07568 8.7433 5.92932 9.07363 5.77461C9.29107 5.67007 9.34543 5.66589 10.1106 5.65335L10.9135 5.63662V4.99267V4.34873H9.59214H8.26661L8.28752 3.97657C8.32515 3.35772 8.57604 2.95629 9.06945 2.72213C9.29107 2.61759 9.34125 2.61341 10.1106 2.60087L10.9135 2.58414V1.29207V-9.53674e-06L8.12444 0.00417233C6.58566 0.00835323 5.28522 0.0208979 5.22668 0.0292606Z" fill="white"/>
                            <path d="M1.33807 6.58167C0.664855 6.76147 0.171441 7.2967 0.0418148 7.98246C0.0167259 8.12463 0 9.5756 0 11.9423V15.6806H2.40435H4.8087L4.80033 16.5461L4.78779 17.4159L4.11875 17.4368C3.4999 17.4577 3.43299 17.4702 3.21974 17.5706C2.63015 17.8591 2.32072 18.3023 2.19946 19.0132L2.17855 19.1512H4.72507C6.13004 19.1512 7.27577 19.1428 7.27577 19.1345C7.27577 19.1261 7.18796 18.9923 7.08342 18.8334C6.1844 17.4953 5.89588 15.8478 6.28894 14.3007L6.38093 13.9243H4.06858H1.75622V10.2237V6.52313L1.64332 6.52731C1.57642 6.52731 1.44261 6.5524 1.33807 6.58167Z" fill="white"/>
                            <path d="M12.21 8.27095V10.0188L12.6407 10.0857C12.8748 10.1233 13.2261 10.207 13.4226 10.2655C13.6191 10.3241 13.8198 10.3868 13.8742 10.3993L13.9662 10.4202V9.34141C13.9662 8.74346 13.9495 8.14969 13.9244 8.0117C13.8407 7.50156 13.5104 7.01232 13.0839 6.76144C12.8957 6.65272 12.4776 6.52309 12.3061 6.52309H12.21V8.27095Z" fill="white"/>
                            <path d="M10.9053 11.4154C9.02365 11.8127 7.62704 13.3682 7.44723 15.2666C7.24652 17.3866 8.61387 19.3351 10.6879 19.8913C11.0558 19.9875 11.1771 20 11.7709 20C12.3605 20 12.4901 19.9875 12.8455 19.8913C16.0653 19.0299 17.2068 15.1202 14.9446 12.7117C14.2881 12.0134 13.456 11.5576 12.5445 11.3903C12.1012 11.3109 11.3444 11.3234 10.9053 11.4154ZM12.3647 12.695C12.5445 12.7326 12.8079 12.8162 12.9584 12.8831L13.2302 13.0086L11.1729 15.0659C8.83967 17.3949 9.08637 17.2277 8.88566 16.6297C8.7184 16.1447 8.69331 15.4673 8.81876 14.9655C9.04874 14.0456 9.60488 13.3682 10.4746 12.9417C11.0851 12.6406 11.7123 12.5612 12.3647 12.695ZM14.5767 14.493C14.7355 14.8526 14.8025 15.1997 14.8025 15.6805C14.8025 16.2158 14.7272 16.5545 14.5097 16.9977C14.1209 17.8005 13.3891 18.3985 12.5026 18.6368C11.9298 18.7916 11.1018 18.7163 10.5373 18.457L10.3115 18.3525L12.3563 16.3078C13.4853 15.1788 14.4219 14.2588 14.4387 14.2588C14.4554 14.2588 14.5181 14.3634 14.5767 14.493Z" fill="white"/>
                        </svg>
                    </button>}
                    {listening && <button onClick={stopRecognition} className={styles.createButtonsItemsActive}>
                        <svg width="14" height="20" viewBox="0 0 14 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M5.3944 0.0468855C4.54579 0.170552 3.80805 0.690808 3.41572 1.44561C3.09589 2.05968 3.11295 1.71 3.11295 7.62044V12.9211H6.6524H10.1918V6.46053V-2.28882e-05L7.92319 0.00424099C6.67372 0.00850582 5.53513 0.0255632 5.3944 0.0468855ZM7.0831 8.08953C7.39014 8.18761 7.79952 8.5842 7.90186 8.88697C8.11508 9.51383 7.85496 10.1961 7.28779 10.5117C7.07884 10.6268 7.0234 10.6396 6.6524 10.6396C6.28139 10.6396 6.22596 10.6268 6.017 10.5117C5.44984 10.1961 5.18971 9.51383 5.40293 8.88697C5.50101 8.59699 5.91466 8.18761 6.20464 8.09379C6.48609 7.99997 6.80165 7.99997 7.0831 8.08953Z" fill="white"/>
                            <path d="M1.20256 6.77612C0.729211 6.93817 0.345416 7.29638 0.119403 7.78679L0.021322 7.99574L0.00852878 11.9915L0 15.9915L2.65245 16L5.30917 16.0128V17.1215V18.2303L4.86141 18.2516C4.47335 18.2687 4.37527 18.29 4.12793 18.4094C3.59062 18.661 3.18124 19.2154 3.1258 19.7612L3.10021 20H6.65245H10.2047L10.1791 19.7655C10.1322 19.3006 9.8081 18.7846 9.40725 18.5288C9.08315 18.3241 8.9339 18.2815 8.4435 18.2559L7.99573 18.2303V17.1215V16.0128L10.6525 16L13.3049 15.9915L13.2964 11.9915L13.2836 7.99574L13.1429 7.70576C12.8827 7.17271 12.3284 6.76333 11.7996 6.70789L11.5565 6.68231L11.548 10.452L11.5352 14.2218H6.65245H1.76972L1.75693 10.4563L1.7484 6.6951H1.58635C1.50107 6.69937 1.32623 6.73348 1.20256 6.77612Z" fill="white"/>
                        </svg>
                    </button>}

                    {password.length === 0
                    ? <button onClick={addPasswordNote} className={`${!text.trim() ? styles.createButtonsItemsInactive : ''} ${isPasswordActive ? styles.createButtonsItemsActive : ''}`}>
                            <span>{strings.createSetPassword}</span> 
                            <svg width="17" height="20" viewBox="0 0 17 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M1.77109 9.02399C1.51474 9.1172 1.04867 9.49006 0.722417 9.83962C0.139823 10.4455 0.139823 10.5154 0.0699113 15.2228L0 20.0001L7.57372 19.9301L15.1708 19.8602L15.9165 19.0912L16.6855 18.3455L16.7554 13.5682L16.8253 8.79095L9.53124 8.81425C5.52299 8.81425 2.02743 8.90747 1.77109 9.02399ZM5.15013 13.4517C5.40647 13.708 5.61621 14.1275 5.61621 14.3839C5.61621 14.9898 4.82388 15.7821 4.21798 15.7821C3.61208 15.7821 2.81976 14.9898 2.81976 14.3839C2.81976 14.1275 3.02949 13.708 3.28583 13.4517C3.54217 13.1954 3.96164 12.9856 4.21798 12.9856C4.47432 12.9856 4.89379 13.1954 5.15013 13.4517ZM9.34481 13.4517C9.60115 13.708 9.81088 14.1275 9.81088 14.3839C9.81088 14.9898 9.01856 15.7821 8.41266 15.7821C7.80676 15.7821 7.01443 14.9898 7.01443 14.3839C7.01443 14.1275 7.22417 13.708 7.48051 13.4517C7.73685 13.1954 8.15632 12.9856 8.41266 12.9856C8.669 12.9856 9.08847 13.1954 9.34481 13.4517ZM13.5395 13.4517C13.7958 13.708 14.0056 14.1275 14.0056 14.3839C14.0056 14.9898 13.2132 15.7821 12.6073 15.7821C12.351 15.7821 11.9315 15.5723 11.6752 15.316C11.4188 15.0597 11.2091 14.6402 11.2091 14.3839C11.2091 14.1275 11.4188 13.708 11.6752 13.4517C11.9315 13.1954 12.351 12.9856 12.6073 12.9856C12.8637 12.9856 13.2831 13.1954 13.5395 13.4517Z" fill="white"/>
                                <path d="M6.78132 0.145168C5.12675 0.681155 3.70522 1.89295 2.9362 3.431C2.70316 3.87377 2.47012 4.94574 2.40021 5.80798L2.28369 7.39264H3.72852H5.15005V6.27406C5.15005 4.96905 5.75595 3.85047 6.82793 3.19796C8.99518 1.86965 11.6751 3.64073 11.6751 6.39058V7.39264H13.0966H14.5415L14.425 5.80798C14.2618 3.431 13.0966 1.61331 11.0925 0.58794C10.0905 0.0752568 7.73677 -0.181085 6.78132 0.145168Z" fill="white"/>
                            </svg>
                    </button>
                    : <button onClick={() => setPassword('')} className={`${!text.trim() ? styles.createButtonsItemsInactive : ''} ${isPasswordActive ? styles.createButtonsItemsActive : ''}`}>
                        <span>{strings.createResetPassword}</span>
                        <svg width="14" height="20" viewBox="0 0 14 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M6.19084 0.019269C5.64863 0.0705013 5.04238 0.245546 4.50871 0.510248C2.95892 1.27447 1.95134 2.74741 1.79764 4.48078C1.75068 5.00591 1.73787 8.30188 1.78484 8.30188C1.80191 8.30188 1.94707 8.20795 2.11358 8.09268C2.70702 7.68709 3.41574 7.32846 4.08177 7.10218L4.42332 6.98691L4.44893 5.69328C4.47455 4.30146 4.47028 4.31427 4.72217 3.81902C4.87587 3.5159 5.29427 3.10604 5.62302 2.93526C6.51532 2.46563 7.47593 2.61506 8.24869 3.34939C8.6372 3.72083 8.97022 3.87453 9.44839 3.89587C9.79848 3.91295 9.85825 3.90014 10.567 3.69094L11.3141 3.46466L11.2116 3.19142C10.695 1.82095 9.52524 0.685293 8.18038 0.237008C7.58266 0.040616 6.84833 -0.0405025 6.19084 0.019269Z" fill="white"/>
                            <path d="M6.00276 8.02864C4.65363 8.22076 3.62044 8.62635 2.68971 9.32653C1.37901 10.3085 0.499518 11.6832 0.123812 13.3312C0.0341551 13.7325 0.0298857 13.8393 0.0170775 16.8705L0 20H6.66451H13.329L13.3119 16.8705C13.2991 13.8393 13.2949 13.7325 13.2052 13.3312C12.7313 11.2392 11.3779 9.51866 9.52073 8.6477C8.59428 8.21649 7.88556 8.04999 6.83529 8.02437C6.44677 8.01583 6.07534 8.0201 6.00276 8.02864ZM6.96764 11.5893C8.10757 11.8028 8.75651 13.0366 8.27407 14.0784C8.16307 14.326 7.84713 14.6974 7.67209 14.7871L7.56108 14.8469V15.5983C7.56108 16.0124 7.53974 16.4223 7.51839 16.5076C7.43727 16.798 7.21953 17.0627 6.94629 17.2036C6.72002 17.3188 6.64317 17.3316 6.22904 17.3487L5.76794 17.3615V16.1063V14.8469L5.65694 14.7871C5.48189 14.6974 5.17023 14.326 5.05495 14.0784C4.58105 13.0452 5.1745 11.8455 6.28027 11.6064C6.57913 11.5381 6.68586 11.5381 6.96764 11.5893Z" fill="white"/>
                        </svg>
                    </button>}

                    <button onClick={saveNote} className={`${!text.trim() ? styles.createButtonsItemsInactive : ''} ${isSaveActive ? styles.createButtonsItemsActive : ''}`}>
                        <span>{strings.createSave}</span>
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M0 8.23333C0 13.2032 0.0212865 16.6586 0.0532163 16.9572C0.22883 18.605 1.43684 19.7941 3.10251 19.9541C3.44842 19.9914 6.61479 20.0074 11.814 19.9968L19.9827 19.9808L19.9987 11.7954C20.004 6.64425 19.9934 3.41278 19.9614 3.07683C19.8976 2.44227 19.7539 1.98901 19.4772 1.56241C19.1792 1.10382 18.9237 0.842529 18.4927 0.549244C17.8488 0.122646 17.588 0.0533237 16.4864 0.0213299L15.5392 0V3.33813V6.68158L10.6539 6.66559L5.77397 6.64959L5.41742 6.47362C4.99701 6.26565 4.73093 5.9777 4.5766 5.57243C4.47549 5.30047 4.47017 5.1565 4.47017 2.65024V0.010664H2.23509H0V8.23333ZM16.6567 13.5818V17.1812H10.0047H3.35263V14.579C3.35263 11.8061 3.36327 11.6568 3.62403 11.1449C3.76772 10.8622 4.2307 10.3983 4.51274 10.2543C5.04491 9.98238 4.8959 9.98771 10.9785 9.98771L16.6567 9.98238V13.5818Z" fill="white"/>
                            <path d="M11.1221 2.49025V4.96985H12.2396H13.3572V2.49025V0.010653H12.2396H11.1221V2.49025Z" fill="white"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div className={styles.createContainer}>
                <input name="nameNote" placeholder={strings.createNameNote} onChange={(e) => setTitle(e.target.value)} />              
                
                {password.length !== 0 && <svg width="17" height="20" viewBox="0 0 17 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M1.77109 9.02393C1.51474 9.11714 1.04867 9.49 0.722417 9.83956C0.139823 10.4455 0.139823 10.5154 0.0699113 15.2227L0 20L7.57372 19.9301L15.1708 19.8602L15.9165 19.0912L16.6855 18.3454L16.7554 13.5682L16.8253 8.79089L9.53124 8.81419C5.52299 8.81419 2.02743 8.90741 1.77109 9.02393ZM5.15013 13.4516C5.40647 13.708 5.61621 14.1275 5.61621 14.3838C5.61621 14.9897 4.82388 15.782 4.21798 15.782C3.61208 15.782 2.81976 14.9897 2.81976 14.3838C2.81976 14.1275 3.02949 13.708 3.28583 13.4516C3.54217 13.1953 3.96164 12.9856 4.21798 12.9856C4.47432 12.9856 4.89379 13.1953 5.15013 13.4516ZM9.34481 13.4516C9.60115 13.708 9.81088 14.1275 9.81088 14.3838C9.81088 14.9897 9.01856 15.782 8.41266 15.782C7.80676 15.782 7.01443 14.9897 7.01443 14.3838C7.01443 14.1275 7.22417 13.708 7.48051 13.4516C7.73685 13.1953 8.15632 12.9856 8.41266 12.9856C8.669 12.9856 9.08847 13.1953 9.34481 13.4516ZM13.5395 13.4516C13.7958 13.708 14.0056 14.1275 14.0056 14.3838C14.0056 14.9897 13.2132 15.782 12.6073 15.782C12.351 15.782 11.9315 15.5723 11.6752 15.3159C11.4188 15.0596 11.2091 14.6401 11.2091 14.3838C11.2091 14.1275 11.4188 13.708 11.6752 13.4516C11.9315 13.1953 12.351 12.9856 12.6073 12.9856C12.8637 12.9856 13.2831 13.1953 13.5395 13.4516Z" fill="#222222"/>
                    <path d="M6.78132 0.145107C5.12675 0.681094 3.70522 1.89289 2.9362 3.43094C2.70316 3.87371 2.47012 4.94568 2.40021 5.80792L2.28369 7.39258H3.72852H5.15005V6.274C5.15005 4.96899 5.75595 3.85041 6.82793 3.1979C8.99518 1.86959 11.6751 3.64067 11.6751 6.39052V7.39258H13.0966H14.5415L14.425 5.80792C14.2618 3.43094 13.0966 1.61324 11.0925 0.587879C10.0905 0.0751958 7.73677 -0.181146 6.78132 0.145107Z" fill="#222222"/>
                </svg>}
            </div>
            <div className={`${styles.createContainer} ${styles.createContent}`}>
                <div
                    ref={editorRef}
                    contentEditable
                    data-placeholder={strings.createText}
                    onInput={handleInput}
                    suppressContentEditableWarning={true}
                ></div>
            </div>
        </div>
    )
}

export default CreateNote